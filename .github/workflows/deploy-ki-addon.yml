name: Deploy KI-Addon to Freemius

on:
  push:
    tags:
      - 'ki-v*'  # Triggered by tags like ki-v1.0.0, ki-v1.1.0

jobs:
  deploy:
    name: Package & Deploy to Freemius
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#ki-v}" >> $GITHUB_OUTPUT

      - name: Create plugin ZIP
        run: |
          cd plugin-ki
          zip -r ../recruiting-playbook-ki.zip . -x ".*"
          cd ..
          echo "Created ZIP:"
          ls -la recruiting-playbook-ki.zip

      - name: Deploy to Freemius
        uses: buttonizer/freemius-deploy@v0.1.3
        with:
          file_name: recruiting-playbook-ki.zip
          version: ${{ steps.version.outputs.VERSION }}
          release_mode: pending
          sandbox: false
        env:
          DEV_ID: ${{ secrets.FREEMIUS_DEV_ID }}
          PUBLIC_KEY: ${{ secrets.FREEMIUS_PUBLIC_KEY }}
          SECRET_KEY: ${{ secrets.FREEMIUS_SECRET_KEY }}
          PLUGIN_SLUG: recruiting-playbook-ki
          PLUGIN_ID: '23996'
