name: Deploy Plugin to Freemius

on:
  push:
    tags:
      - 'v*'  # Triggered by tags like v1.1.0, v1.2.0 (NOT ki-v*)
      - '!ki-v*'  # Exclude KI-Addon tags

jobs:
  deploy:
    name: Build, Package & Deploy to Freemius
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Composer dependencies (production)
        working-directory: plugin
        run: composer update --no-dev --optimize-autoloader --no-interaction --ignore-platform-req=php

      - name: Install npm dependencies
        working-directory: plugin
        run: npm ci

      - name: Build assets
        working-directory: plugin
        run: npm run build

      - name: Verify no uninstall.php exists
        working-directory: plugin
        run: |
          echo "=== Checking for uninstall.php files ==="
          if find . -name "uninstall.php" -type f | grep -q .; then
            echo "WARNING: uninstall.php found!"
            find . -name "uninstall.php" -type f
            echo "Removing uninstall.php files..."
            find . -name "uninstall.php" -type f -delete
          else
            echo "OK: No uninstall.php found"
          fi
          echo ""
          echo "=== Checking for register_uninstall_hook calls (excluding vendor/freemius) ==="
          grep -r "register_uninstall_hook" --include="*.php" -l . | grep -v "vendor/freemius" | grep -v "vendor/php-stubs" || echo "OK: No register_uninstall_hook calls found"

      - name: Create plugin ZIP
        run: |
          cd plugin
          zip -r ../recruiting-playbook.zip . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "tests/*" \
            -x "*.lock" \
            -x "phpunit.xml*" \
            -x "phpcs.xml*" \
            -x ".eslintrc*" \
            -x ".stylelintrc*" \
            -x "assets/src/*" \
            -x "*.map" \
            -x "uninstall.php"
          cd ..
          echo "Created ZIP:"
          ls -la recruiting-playbook.zip

      - name: Debug ZIP contents
        run: |
          echo "=== Root-level PHP files in ZIP ==="
          unzip -l recruiting-playbook.zip | grep "\.php$" | grep -v "/" | head -20
          echo ""
          echo "=== All root-level files ==="
          unzip -l recruiting-playbook.zip | grep -E "^\s+[0-9]+" | awk '{print $NF}' | grep -v "/" | sort
          echo ""
          echo "=== Searching for uninstall in ZIP ==="
          unzip -l recruiting-playbook.zip | grep -i "uninstall" || echo "No uninstall files found in ZIP"
          echo ""
          echo "=== Total files ==="
          unzip -l recruiting-playbook.zip | tail -1

      - name: Deploy to Freemius
        uses: buttonizer/freemius-deploy@v0.1.3
        with:
          file_name: recruiting-playbook.zip
          version: ${{ steps.version.outputs.VERSION }}
          release_mode: pending
          sandbox: false
        env:
          DEV_ID: ${{ secrets.FREEMIUS_DEV_ID }}
          PUBLIC_KEY: ${{ secrets.FREEMIUS_PUBLIC_KEY }}
          SECRET_KEY: ${{ secrets.FREEMIUS_SECRET_KEY }}
          PLUGIN_SLUG: recruiting-playbook
          PLUGIN_ID: '23533'
