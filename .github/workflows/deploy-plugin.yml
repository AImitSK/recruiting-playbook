name: Deploy Plugin to Freemius

on:
  push:
    tags:
      - 'v*'  # Triggered by tags like v1.1.0, v1.2.0 (NOT ki-v*)
      - '!ki-v*'  # Exclude KI-Addon tags

jobs:
  deploy:
    name: Build, Package & Deploy to Freemius
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Composer dependencies (production)
        working-directory: plugin
        run: composer update --no-dev --optimize-autoloader --no-interaction --ignore-platform-req=php

      - name: Install npm dependencies
        working-directory: plugin
        run: npm ci

      - name: Build assets
        working-directory: plugin
        run: npm run build

      - name: Merge JSON translation files for webpack bundles
        working-directory: plugin
        run: python3 tools/merge-json-translations.py languages

      - name: Clean up and create plugin ZIP
        run: |
          cd plugin

          # Forcefully remove any uninstall.php (Freemius requires after_uninstall hook instead)
          find . -name "uninstall.php" -type f -exec rm -f {} \; 2>/dev/null || true
          rm -f uninstall.php 2>/dev/null || true

          echo "=== PHP files at root level ==="
          ls -la *.php

          echo ""
          echo "=== Checking for uninstall.php ==="
          if [ -f "uninstall.php" ]; then
            echo "ERROR: uninstall.php still exists after deletion!"
            exit 1
          else
            echo "OK: No uninstall.php"
          fi

          # Create fresh ZIP (delete old one first)
          cd ..
          rm -f recruiting-playbook.zip

          cd plugin
          zip -r ../recruiting-playbook.zip . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "tests/*" \
            -x "tools/*" \
            -x "mu-plugins/*" \
            -x ".phpunit.cache/*" \
            -x "assets/src/css/*" \
            -x "assets/src/js/admin/*" \
            -x "assets/src/js/blocks/*" \
            -x "assets/src/js/*.js" \
            -x "*.lock" \
            -x "*.map" \
            -x "*.log" \
            -x "phpunit.xml*" \
            -x "phpcs.xml*" \
            -x ".eslintrc*" \
            -x ".stylelintrc*" \
            -x ".prettierrc*" \
            -x ".gitignore" \
            -x "package.json" \
            -x "postcss.config.js" \
            -x "tailwind.config.js" \
            -x "webpack.config.js" \
            -x "playwright.config.ts" \
            -x "screenshot-*.png" \
            -x "*/uninstall.php" \
            -x "./uninstall.php" \
            -x "uninstall.php"

          cd ..
          echo ""
          echo "=== Created ZIP ==="
          ls -la recruiting-playbook.zip

          echo ""
          echo "=== Verify no uninstall.php in ZIP ==="
          if unzip -l recruiting-playbook.zip | grep -qi "uninstall\.php"; then
            echo "ERROR: uninstall.php found in ZIP! Removing it..."
            zip -d recruiting-playbook.zip "uninstall.php" "*/uninstall.php" "./uninstall.php" 2>/dev/null || true
            echo "After removal:"
            unzip -l recruiting-playbook.zip | grep -i "uninstall" || echo "OK: Removed successfully"
          else
            echo "OK: No uninstall.php in ZIP"
          fi

          echo ""
          echo "=== Root-level PHP files in ZIP ==="
          unzip -l recruiting-playbook.zip | grep "\.php$" | grep -v "/" | head -20

          echo ""
          echo "=== Total files ==="
          unzip -l recruiting-playbook.zip | tail -1

      - name: Deploy to Freemius
        uses: buttonizer/freemius-deploy@v0.1.3
        with:
          file_name: recruiting-playbook.zip
          version: ${{ steps.version.outputs.VERSION }}
          release_mode: pending
          sandbox: false
        env:
          DEV_ID: ${{ secrets.FREEMIUS_DEV_ID }}
          PUBLIC_KEY: ${{ secrets.FREEMIUS_PUBLIC_KEY }}
          SECRET_KEY: ${{ secrets.FREEMIUS_SECRET_KEY }}
          PLUGIN_SLUG: recruiting-playbook
          PLUGIN_ID: '23533'
